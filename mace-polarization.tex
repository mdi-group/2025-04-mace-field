% REVTeX guide: https://www.ctan.org/tex-archive/macros/latex/contrib/revtex
\documentclass[aps,physrev,graphicx,amsmath,amssymb,reprint]{revtex4-2} % Two-column 'reprint'
%\documentclass[aps,physrev,graphicx,amsmath,amssymb,linenumbers,preprint]{revtex4-2}

% PACKAGES
\usepackage{graphicx}
\usepackage{subfig}
\usepackage{physics}
\usepackage{mathtools}
\usepackage[version=3]{mhchem} % Formula subscripts using \ce{}
\usepackage{dcolumn} % Align table columns on decimal point
\usepackage{bm} % bold math
\usepackage{xcolor}
\usepackage{siunitx}
\usepackage[font=small,labelfont=bf,
   justification=Justified,
   singlelinecheck=off,
   format=plain]{caption} % 'format=plain' avoids hanging indentation
\usepackage{parskip}

% MATH TIDBITS
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

% COMMANDS
\newcolumntype{d}[1]{D{.}{\cdot}{#1}}

% FONT OPTIONS; mainly to break monotony when doing rounds of edits
\usepackage{mathpazo}

\begin{document}
\title{
Macroscopic Electric Polarization in MACE Machine Learned Interatomic Potentials
}
\date{\today} % useful to track hard copy of drafts

\author{Bradley A. A. Martin}
\author{Keith T. Butler}
\email[Electronic mail: ]{k.t.butler@ucl.ac.uk}

\affiliation{Department of Chemistry, University College London, Gower Street, London, WC1E 6BT, UK}

\author{Another A. Author}
\affiliation{Department, Other University, Road, City, Postcode, Country}

\keywords{key, word}

\begin{abstract}
    
\end{abstract}

\maketitle 

\section{Introduction}\label{section: introduction}

Predicting the macroscopic electric response of crystals is currently a computationally intensive process due to the inherent quantum nature of polarisation. In the Modern Theory of Polarisation, the polarisation is derived from a geometric quantum ``Berry'' phase, and is ill-defined within a periodic crystal. Therefore, the calculation of macroscopic physical properties from derivatives of the polarisation, such as dielectric permittivity and effective charges, often requires numerous expensive electronic structure calculations to determine the polarisation difference between two crystal states, e.g. a non-polar centro-symmetric state and a polar ferroelectric state. We are then limited to small-scale simulation by the scaling of computation cost. 

\textcolor{blue}{Introduction to ferroelectric materials and applications. Spontaneous polarisation.}

\textcolor{blue}{Description of development and application of Machine learned force fields. Introduce ACE and MACE.}


In this study we extend the MACE architecture to respond to an external electric field, which couples to a polarisation feature in the model. Existing approaches (Allegro, CACE, LES etc.) focused on select materials (BaTiO3, bulk water etc.), here we train our model on ~5000 different polar crystal materials to predict polarisation, Born Effective Charge (BEC) and polarisability.

\section{Theory}\label{section: theory}

\begin{itemize}
\color{blue}
    \item Introduce a brief overview of modern approach of polarisation (King-Smith \& Vanderbilt, and Resta).
    \item How electronic structure methods (DFPT) implement polarisation and the electric enthalpy (Nunes \& Gonze and  Souza, Íñiguez, \& Vanderbilt).
    \item How macroscopic properties, BECs \& polarisability etc., defined (derivatives of energy w.r.t positions, electric field etc.).
    \item Theory behind ferroelectric materials and spontaneous polarisation.
    \item Relation to other notable macroscopic properties, e.g. dielectric constants, optical conductivity etc.
\end{itemize}

\begin{equation}
    \vb{P} = \frac{1}{\mathcal{V}} \left[ -e \sum_{\alpha} Z_\alpha \vb{R}_\alpha + \int d\vb{r}\ \vb{r}\ \rho(\vb{r}) \right]
\end{equation}

\begin{equation}
    \Delta \vb{P} = \Delta \vb{P}_{\text{ion}} + \Delta \vb{P}_{\text{el}}
\end{equation}

\begin{equation}
    \Delta \vb{P}_{\text{el}} = \frac{1}{\mathcal{V}} \int d\vb{r}\ \vb{r}\ \rho(\vb{r})
\end{equation}

\begin{equation}
    \vb{P}_\alpha = \frac{2 e}{\Omega} \vb{R}_\alpha
\end{equation}

\begin{equation}
    E\left[\left\{\psi^{(\bm{\mathcal{E}})}\right\}, \bm{\mathcal{E}}\right] = E_0\left[\left\{ \psi^{(\bm{\mathcal{E}})} \right\}\right] - \Omega\ \bm{\mathcal{E}} \cdot \vb{P}\left[\left\{ \psi^{(\bm{\mathcal{E}})} \right\}\right]
\end{equation}


\section{Methodology}\label{section: methods}

\subsection{Architecture}

Our approach inherits most of the original MACE architecture. The primary alteration is in the readout blocks where we include an additional energy term, $-\vb{P} \cdot \bm{\mathcal{E}}$, in analogy to the electric enthalpy functional from Density Functional Perturbation Theory.
\begin{widetext}
\begin{equation}
\begin{aligned}
    E_\alpha & = E_\alpha^{(0)} + E_\alpha^{(1)} + \dots + E_\alpha^{(T)}, \qquad \text{where}, \\ \\
    E_\alpha(t) &= \mathcal{R}_t\left(\vb{h}_i^{(t)}\right) = 
    \begin{cases}
    \begin{aligned}
        &\sum_{\Tilde{k}} W_{\text{readout}, \Tilde{k}}^{(t)} \left[ h_{\alpha,\Tilde{k} 0 0}^{e, (t)} - \vb{p}_{\alpha, \Tilde{k}}^{(t)} \cdot \bm{\mathcal{E}} \right] \qquad\ \text{if}\ t<T, \\
        &\text{MLP}_{\text{readout}}^{(t)}\left( \left\{ h_{\alpha,k 0 0}^{e, (t)} - \vb{p}_{\alpha, k}^{(t)} \cdot \bm{\mathcal{E}} \right\}_{k} \right) \quad \text{if}\ t = T.
    \end{aligned}
    \end{cases}
\end{aligned}
\end{equation}
\end{widetext}
To preserve higher-order tensorial information for the final readout blocks, we allow $l>0$ spherical harmonic features in the final layers of the interaction and product blocks.

After the higher body-order node features are produced, we linearly map them to two scalar features and one vector feature which we may relate to the local node energy, charge and electronic dipole moment,
\begin{equation}
    \left[ h_{\alpha, k 0 0}^{e, (t)},\ h_{\alpha, k 0 0}^{q, (t)},\ h_{\alpha, k 1 m}^{(t)} \right] = \sum_{l \Tilde{m}} W^{l \Tilde{m}}_{0 0, 1 m} h^{(t)}_{\alpha,kl\Tilde{m}}.
\end{equation}
Note that these are not complete readouts yet as we have not yet mixed the $k$ channels. We then define a total dipole moment feature as,
\begin{equation}
    \vb{p}^{(t)}_{\alpha,k} = h^{q,(t)}_{\alpha,k 0 0} \vb{R}_{\alpha} - \vb{h}^{(t)}_{\alpha,k 1},
\end{equation}
where the first term represents the atomic dipole contribution. This `total dipole' acts as an atomic decomposition of the total macroscopic polarisation and, dot product with the external electric field, contributes to the total energy.

\subsection{Derivative Macroscopic Properties}

The predicted energy $E$ depends upon the atomic positions $\vb{R}_{\alpha}$ and the external electric field $\bm{\mathcal{E}}$ to arbitrary order, 
\begin{widetext}
\begin{equation}
    E(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) = E^{(0)}(\bm{\mathcal{E}}) + \sum_{\alpha=1}^N E_{\alpha}^{(0)}\left( \vb{R}_{\alpha};\  \bm{\mathcal{E}} \right) + \sum_{1 \leq \alpha \leq \beta \leq N}^N E_{\alpha, \beta}^{(1)}\left( \vb{R}_{\alpha}, \vb{R}_{\beta};\ \bm{\mathcal{E}} \right) + \dots + \mathcal{F}\left[m^{(T)}\left(\vb{R}_{\alpha_1}, \dots, \vb{R}_{\alpha_N};\  \bm{\mathcal{E}}\right)\right],
\end{equation}  
\end{widetext}
where $\mathcal{F}$ is a general, learnable non-linear term (here evaluated using a MLP) that accounts for excluded higher-order terms.

The most general expansion of $E$ to second order in $\bm{\mathcal{E}}$, and to all orders in $\vb{R}_{\alpha}$, is
\begin{equation}
\begin{aligned}
    \Tilde{E}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) &\simeq E_0(\{\vb{R}_\alpha\}) \\
    &- \Omega\ \bm{\mathcal{E}} \cdot \vb{P}_0(\{\vb{R}_\alpha\}) \\
    &- \frac{\Omega}{8\pi}\ \bm{\mathcal{E}} \cdot \bm{\varepsilon}(\{\vb{R}_\alpha\}) \cdot \bm{\mathcal{E}},
\end{aligned}
\end{equation}
where $\vb{P}_0(\{\vb{R}_\alpha\})$ is the macroscopic polarisation in zero field (or the  ``built-in'' polarisation), and $\bm{\varepsilon}(\{\vb{R}_\alpha\})$ is the macroscopic (optical) dielectric tensor. For most materials, $\vb{P}_0(\{\vb{R}_\alpha\}) = 0$, but this is not true for ferroelectric materials which have a finite polarisation even with no external field.

The generalised force $\vb{F}_\beta$ from displacing atom $\beta$ is obtained as a conjugate variable,
\begin{equation}
\begin{aligned}
    \vb{F}_{\beta}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) &= -\frac{1}{\Omega} \grad_{\vb{R}_{\beta}} \Tilde{E}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) \\
    &= -\frac{1}{\Omega} \grad_{\vb{R}_{\beta}} E_0(\{\vb{R}_\alpha\}) \\
    &\quad\ + \bm{\mathcal{E}} \cdot \grad_{\vb{R}_{\beta}} \vb{P}_0(\{\vb{R}_\alpha\}) \\
    &\quad\ + \frac{1}{8\pi}\ \bm{\mathcal{E}} \cdot \grad_{\vb{R}_{\beta}} \bm{\varepsilon}(\{\vb{R}_\alpha\}) \cdot \bm{\mathcal{E}}.
\end{aligned}
\end{equation}
Likewise, we may derive the electric displacement field $\vb{D}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}})$,
\begin{equation}
\begin{aligned}
    \vb{D}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) &= -4\pi \grad_{\bm{\mathcal{E}}} \vb{F}_{\beta}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) \\
    &= \bm{\varepsilon}(\{\vb{R}_\alpha\}) \cdot \bm{\mathcal{E}} + 4\pi \vb{P}_0(\{\vb{R}_\alpha\}),
\end{aligned}
\end{equation}
which relates the macroscopic polarisation in a finite electric field $\vb{P}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}})$ to one in zero field $\vb{P}_0(\{\vb{R}_\alpha\})$,
\begin{equation}
    \vb{P}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) = \vb{P}_0(\{\vb{R}_\alpha\}) + \alpha(\{\vb{R}_\alpha\}) \cdot  \bm{\mathcal{E}},
\end{equation}
where $\alpha = (\varepsilon - 1) / 4\pi$ is the macroscopic polarisability tensor.

The presence of the electric field in the non-linear function (the MLP) means that we account for higher order terms in the electric field too, $\mathcal{E}^3, \mathcal{E}^4 \dots$. Therefore, we account for non-linear susceptibilities,
\begin{equation}
\begin{aligned}
    \vb{P}(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) &= -\frac{1}{\Omega} \grad_{\bm{\mathcal{E}}} E(\{\vb{R}_\alpha\}, \bm{\mathcal{E}}) \\
    &= \vb{P}_0(\{\vb{R}_\alpha\}) + \chi^{(1)}(\{\vb{R}_\alpha\}) \cdot  \bm{\mathcal{E}} \\
    &+ \bm{\mathcal{E}} \cdot \chi^{(2)}(\{\vb{R}_\alpha\}) \cdot  \bm{\mathcal{E}} + \dots,
\end{aligned}
\end{equation}
where we see that the polarisability is the linear susceptibility term, $\chi^{(1)} \equiv \alpha$.

The Born effective charges ($Z^*_{\alpha,ij}$) and the polarisability tensor ($\alpha_{ij}$) may then be derived from derivatives of the polarisation with respect to atom position and the electric field, respectively,
\begin{subequations}
\begin{align}
    \alpha_{ij} &= - \frac{1}{\Omega} \frac{\partial^2 E}{\partial \mathcal{E}_i\ \partial \mathcal{E}_j} = \frac{\partial P_i}{\partial \mathcal{E}_j} \\
    Z^*_{\alpha, ij} &= -\frac{1}{e}\frac{\partial^2 E}{\partial \mathcal{E}_i\ \partial R_{\alpha,j}} = \frac{1}{e} \frac{\partial F_i}{\partial \mathcal{E}_j} = \frac{\Omega}{e} \frac{\partial P_i}{\partial R_{\alpha, j}}.
\end{align}
\end{subequations}

\subsection{Loss}

\section{Results}\label{section: results}

\subsection{Polarisation of Ferroelectric Materials}

\subsection{BEC and Polarisability of Dielectric Crystals}

\bibliography{bibliography}

\end{document}

